<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8" />
    <title>分片上传到本地</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/spark-md5/3.0.2/spark-md5.min.js"></script>    <style>
        .upload-container {
          max-width: 600px;
          margin: 40px auto;
          padding: 20px;
          font-family: Arial, sans-serif;
        }
        .progress-bar {
          width: 100%;
          background: #f0f0f0;
          border-radius: 4px;
          margin: 10px 0;
        }
        .progress {
          height: 20px;
          background: #409eff;
          border-radius: 4px;
          text-align: center;
          color: white;
          font-size: 12px;
          line-height: 20px;
        }
        button {
          margin-right: 10px;
          margin-top: 10px;
        }
    </style>
</head>
<body>
<div id="app" class="upload-container">
    <h1>请选择要上传的文件</h1>

    <input type="file" @change="onFileSelect" :disabled="uploading" />
    <br /><br />

    <div v-if="file">
        文件：{{ file.name }} ({{ formatSize(file.size) }})
    </div>

    <div class="progress-bar" v-if="progress > 0">
        <div class="progress" :style="{ width: progress + '%' }">
            {{ Math.round(progress) }}%
        </div>
    </div>

    <div>
        <button @click="startUpload" :disabled="uploading || !file">开始上传</button>
        <button @click="pauseUpload" v-if="uploading">暂停</button>
        <button @click="resumeUpload" v-if="paused">继续</button>
        <button @click="cancelUpload" v-if="uploading || paused">取消</button>
    </div>

    <div v-if="fileUrl">
        <p>✅ 上传完成！</p>
        <a :href="fileUrl" target="_blank">下载文件</a>
    </div>
</div>

<script>
    const { createApp, ref } = Vue;

    createApp({
      setup() {
        const file = ref(null);
        const uploading = ref(false);
        const paused = ref(false);
        const progress = ref(0);
        const fileUrl = ref('');
        const controller = new AbortController();
        let uploadId = '';
        let fileName = '';
        let fileMd5 = '';
        let totalChunks = 0;
        let uploadedChunks = new Set();

        const formatSize = (bytes) => {
          if (bytes === 0) return '0 B';
          const k = 1024;
          const sizes = ['B', 'KB', 'MB', 'GB'];
          const i = Math.floor(Math.log(bytes) / Math.log(k));
          return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        };

        const onFileSelect = (e) => {
          file.value = e.target.files[0];
        };

        const computeMD5 = (file) => {
          return new Promise((resolve) => {
            const spark = new SparkMD5.ArrayBuffer();
            const reader = new FileReader();
            reader.onload = (e) => {
              spark.append(e.target.result);
              resolve(spark.end());
            };
            reader.readAsArrayBuffer(file);
          });
        };

        const initUpload = async () => {
          fileMd5 = await computeMD5(file.value);
          const res = await axios.post('http://localhost:8081/api/file/init', {
            fileName: file.value.name,
            fileMd5,
            fileSize: file.value.size
          });
          const data = res.data.data;
          if (data.url) {
            fileUrl.value = data.url;
            progress.value = 100;
            return false;
          }
          uploadId = data.uploadId;
          fileName = data.fileName;
          totalChunks = data.totalChunks;
          return true;
        };

        const getUploadedChunks = async () => {
          const res = await axios.get('http://localhost:8081/api/file/uploaded-chunks', {
            params: { uploadId }
          });
          uploadedChunks = new Set(res.data);
        };

        const uploadChunk = async (chunk, index) => {
          const formData = new FormData();
          formData.append('chunk', chunk);
          formData.append('uploadId', uploadId);
          formData.append('fileName', fileName);
          formData.append('chunkIndex', index);
          formData.append('totalChunks', totalChunks);

          await axios.post('http://localhost:8081/api/file/upload-chunk', formData, {
            headers: { 'Content-Type': 'multipart/form-data' },
            signal: controller.signal
          });
        };

        const startUpload = async () => {
          if (!file.value || uploading.value) return;
          uploading.value = true;
          paused.value = false;

          const needUpload = await initUpload();
          if (!needUpload) return;

          await getUploadedChunks();

          const chunkSize = 5 * 1024 * 1024;
          const chunks = Math.ceil(file.value.size / chunkSize);

          try {
            for (let i = 0; i < chunks; i++) {
              if (paused.value) break;
              if (uploadedChunks.has(i)) {
                progress.value = Math.round(((i + 1) / chunks) * 100);
                continue;
              }

              const start = i * chunkSize;
              const end = Math.min(start + chunkSize, file.value.size);
              const chunk = file.value.slice(start, end);

              await uploadChunk(chunk, i);
              progress.value = Math.round(((i + 1) / chunks) * 100);
            }

            if (progress.value === 100 && !paused.value) {
              await axios.post('http://localhost:8081/api/file/complete', {
                uploadId,
                fileName,
                totalChunks,
                fileMd5
              });
              fileUrl.value = `http://localhost:8081/api/file/download?fileName=${encodeURIComponent(fileName)}`;
            }
          } catch (err) {
            if (err.name !== 'AbortError') {
              alert('上传失败：' + err.message);
            }
          } finally {
            uploading.value = false;
          }
        };

        const pauseUpload = () => {
          paused.value = true;
          controller.abort();
          controller = new AbortController();
        };

        const resumeUpload = () => {
          paused.value = false;
          startUpload();
        };

        const cancelUpload = () => {
          controller.abort();
          uploading.value = false;
          paused.value = false;
          progress.value = 0;
          file.value = null;
          fileUrl.value = '';
        };

        return {
          file,
          uploading,
          paused,
          progress,
          fileUrl,
          onFileSelect,
          startUpload,
          pauseUpload,
          resumeUpload,
          cancelUpload,
          formatSize
        };
      }
    }).mount('#app');
</script>
</body>
</html>